<!doctype html>
<html>
  <head>
    <title>FakeNewsAcademy</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel= "stylesheet" type= "text/css" href="{{ url_for('static', filename='results.css')}}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico')}}" />

    <!-- SEARCHBAR -->
    <link href="{{ url_for('static', filename='searchbar.css')}}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='global.css')}}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='navbar.css')}}" rel="stylesheet" />

    <!-- Bootstrap -->
    <link href="{{ url_for('static', filename='bts4.min.css')}}" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <script src="{{ url_for('static', filename='jquery.min.js')}}"></script>
    <script src="{{ url_for('static', filename='jquery.3-5-1.min.js')}}"></script>
    <script src="{{ url_for('static', filename='popper.min.js')}}"></script>
    <script src="{{ url_for('static', filename='bootstrap.min.js')}}"></script>

  </head>
  <body>
    <script>
      var results = {{ results|tojson }};
      var papers = results['item-list'];
      console.log(results);
    </script>

    {% include 'navbar.html' %}

    <div class="row">

      <div class="col-1-5">
        {% include 'vert-navbar.html' %}
      </div>

      <div class="col-xs-12 col-md-9">
    <div class="container-fluid">

      <div class="row">
      </div>

      <div class="row indrow">
        <div class="col-xs-0 col-md-1"></div>
        <div class="col-xs-12 col-md-10" id='search-box'>
          {% include 'searchbar.html' %}
        </div>

        <div class="col-xs-0 col-md-1"></div>
      </div>

      <div class="row indrow">
        <div class="col-xs-0 col-md-1"></div>

        <div id = 'pagination1' class="col-xs-12 col-md-10">
        </div>

      <div class="col-xs-0 col-md-1"></div>
      </div>

      <div class="row indrow">
        <div class="col-xs-0 col-md-1"></div>

        <div id = 'results' class="col-xs-12 col-md-10">
        </div>

      <div class="col-xs-0 col-md-1"></div>
      </div>

      <div class="row indrow">
        <div class="col-xs-0 col-md-1"></div>

        <div id = 'pagination2' class="col-xs-12 col-md-10">
        </div>

      <div class="col-xs-0 col-md-1"></div>
      </div>


      <div class="row indrow">
      </div>


    </div> <!-- end container -->
  </div><!-- end col -->
  <div class="col-1-5"></div>
  </div><!-- end row -->




    <script>

        // This function transforms a number (say, betweenness) into a picture (as of now, the diamond picture only)
        // there is an array `scale`, with 4 entries: [a, b, c, d]
        // you search if your paper has betweenness < a, then it is class 0; betweenness < b, then it is class 1 ...
        // class 4 paper, with betweenness > c, have the diamond
        let rank = function(value, scale, what){
          var img = ['<img src="{{ url_for('static', filename='img/_0.png') }}" width="20px" height="20px" alt="0">',
                    '<img src="{{ url_for('static', filename='img/_1.png') }}" width="20px" height="20px" alt="1">',
                    '<img src="{{ url_for('static', filename='img/_2.png') }}" width="20px" height="20px" alt="2">',
                    '<img src="{{ url_for('static', filename='img/_3.png') }}" width="20px" height="20px" alt="3">',
                    '<img src="{{ url_for('static', filename='img/4.png') }}" width="20px" height="20px" alt="4">'];
          for (i = 0; i < 4; i++) {
            if (scale[i] >= value) {
              if (i >= 3){

                return('<span class="centr">' + img[i] + '</img><span class="centr_text">' + what + '</span></span>');
              }else{
                return('');
              }
            }
          }

          return('<span class="centr">' + img[3] + '</img><span class="centr_text">' + what + '</span></span>');
        }


        // This function sends the current query parameters + the page the user clicked on, receives new data and calls a new page update
        let paginate = function(page){

          var query = results['query'];

          $.getJSON({
            url: "/updatepage",
            data: { title: query.title,
                    author: query.author,
                    cit_min: query.cits[0],
                    cit_max: query.cits[1],
                    year_min: query.years[0],
                    year_max: query.years[1],
                    sort_by: query.sort_by,
                    in_abstract: query.in_abstract,
                    in_referenced: query.in_referenced,
                    page: page
            },
            success: function(data){
              init(data);
              // window.location.href = '#search-box';
              document.getElementById("search-box").scrollIntoView();

              }
            });
        }

        // This function creates the html for clickable authors
        let get_authors = function(authors){

          authors = authors.replace(' ~', ',');
          var x = '&nbsp;';
          if(authors.includes(',')){
            authors = authors.split(', ');
            for(i = 0; i < authors.length; i++){
              x = x.concat('<span class="plaintext"><form class="plaintext" action="/search" method="post"><input class="plaintext" type="submit" name="author", value="' + authors[i] + '" ></form></span>');
              if(i < authors.length - 1){
                x = x.concat('<span class="plaintext">,&nbsp;</span>');
              }
            }
          }else{
            x = x.concat('<span class="plaintext"><form class="plaintext" action="/search" method="post"><input class="plaintext" type="submit" name="author", value="' + authors + '" ></form></span>');
          }

          return(x)
        }

        // This function draws the page buttons for pagination
        // If you are at first page, Previous must be disabled; if you are at last page, Next must be disabled;
        let draw_page_buttons = function(item_number, page){

          var s = '';
          s = s.concat('<nav aria-label="..."><ul class="pagination">')
          if(item_number > 20){
            n_pages = Math.ceil(item_number / 20);

            // Computing how many buttons to draw
            if(page == 1){
              i_min = 1;
              i_max = Math.min(page + 4, n_pages);

            }else if(page == n_pages){
              i_min = Math.max(page - 4, 1);
              i_max = n_pages;

            }else{
              i_min = Math.max(page - 2, 1);
              i_max = Math.min(page + 2, n_pages);

              // A quick fix for the case page == 2 or page == (n_pages - 1), wich yelds i_min and i_max not symmetric around page
              if ((i_max - i_min) < 4){
                if((i_max - page) < 2){
                  i_min = Math.max(1, i_min - 1)
                }else{
                  i_max = Math.min(n_pages, i_max + 1)
                }
              }
            }


            // Drawing PREVIOUS
            if (page == 1){
              s = s.concat('<li class="page-item disabled"><a class="page-link" tabindex="-1" onclick="paginate(' + (page - 1) +')">Previous</a></li>');
            }else{
              s = s.concat('<li class="page-item"><a class="page-link" tabindex="-1" onclick="paginate(' + (page - 1) +')">Previous</a></li>');
            }

            // Drawing page buttons
            for( i=i_min; i<= i_max; i++){
              if(i == page){
                s = s.concat('<li class="page-item active"><a class="page-link page-active">'+ page +'<span class="sr-only">(current)</span></a></li>');
              }else{
                s = s.concat('<li class="page-item"><a class="page-link" onclick="paginate(' + i + ')">'+ i +'</a></li>');
              }
            }

            // Drawing NEXT
            if (page < n_pages){
              s = s.concat('<li class="page-item"><a class="page-link" onclick="paginate(' + (page + 1) +')">Next</a></li>');
            }else{
              s = s.concat('<li class="page-item disabled"><a class="page-link" onclick="paginate(' + (page + 1) +')">Next</a></li>');
            }

          }else{
            s = s.concat('<li class="page-item disabled"><a class="page-link">Previous</a></li>');
            s = s.concat('<li class="page-item disabled"><a class="page-link">1</a></li>');
            s = s.concat('<li class="page-item disabled"><a class="page-link">Next</a></li>');
          }

          s = s.concat('</ul></nav>');

          var what = results.query.title;
          if(what == ' '){
            what = results.query.author;
          }
          if(what == ' '){
            what = results.query.tag;
          }

          if(item_number > 20){
            document.getElementById('pagination2').innerHTML = s;
          }

          if(what == ' '){
            s = s.concat('<span>' + parseInt(item_number) + ' total results.</span>');
          }else{
            s = s.concat('<span>' + parseInt(item_number) + ' total results for "' + what + '".</span>');
          }

          document.getElementById('pagination1').innerHTML = s;
        }



        // This function initialises the results div. It makes a list of `row entry`, each a paper.
        let init = function(data){

          papz = data['item-list'];
          draw_page_buttons(data['item-total-number'], parseInt(data.query.page));

          if(papz.length > 0){
            var s = '';
            jQuery.each(papz, function() {
               s = s.concat('<div class="row entry"> \n');
               s = s.concat('<div class="col-xs-12 col-md-12">');

              s = s.concat('<div class="row">');
              s = s.concat('<span><a class="title_p" href="/paper/' + this.paper_id + '">' + this.title + '</a></span>');
              s = s.concat('</div>');

              s = s.concat('<div class="row">');
              s = s.concat('<span><p class="auth_p">(' + this.year + ')</p></span>' + get_authors(this.author) + '\n');
              s = s.concat('</div>');

              s = s.concat('<div class="row">');
              s = s.concat('</div>');


              s = s.concat('<div class="row tags">');
              jQuery.each(this.tags, function(){
                  s = s.concat('<span class="badge badge-primary badge-project"><form class="tagtext" action="/search" method="post"><input class="tagtext" type="submit" name="tag", value="' + this + '" ></form></span>');
                  // <form class="plaintext" action="/search" method="post"><input class="plaintext" type="submit" name="author", value="' + authors[i] + '" ></form>
                });
              s = s.concat('</div>');



              s = s.concat('<div class="row"><br></div>');

              s = s.concat('<div class="row">');
              s = s.concat('<div class="col-xs-8 col-md-10">');
              s = s.concat('<span class="cits">' + this.cit + ' citations</span>\n');
              s = s.concat(rank(this.pagerank, results['scales']['pagerank'], 'pagerank'));
              s = s.concat(rank(this.hubs, results['scales']['hubs'], 'hubs'));
              s = s.concat(rank(this.authorities, results['scales']['authorities'], 'authorities'));
              s = s.concat(rank(this.betweenness, results['scales']['betweenness'], 'betweenness'));
              s = s.concat('</div>');
              s = s.concat('<div class="col-xs-4 col-md-2">');
              if(this.links.length != 0){
                s = s.concat('<span class="dropdown paper_button d-flex justify-content-end">');
                s = s.concat('<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">View paper on:</button>');
                s = s.concat('<div class="dropdown-menu">');

                for(i = 0; i < this.links.length; i++){
                  s = s.concat('<a class="paper_link dropdown-item" href="' + this.links[i] +'" target="_blank">' + this.domains[i] + '</a>')
                }
                s = s.concat('</div></span>');
              }
              s = s.concat('</div> \n');
              s = s.concat('</div> \n');

              s = s.concat('</div> \n');
              s = s.concat('</div> \n');

            });

          document.getElementById('results').innerHTML = s;

        }else{
          document.getElementById('results').innerHTML = "No papers found.";
        }

      }


      $(document).ready(function () {
        init(results);
      });




    </script>

  <script type="text/javascript" src="{{ url_for('static', filename = 'search.js')}}" defer></script>
</body>
</html>
